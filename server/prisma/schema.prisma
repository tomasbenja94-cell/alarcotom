// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

generator seed {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Category {
  id           String    @id @default(uuid())
  name         String
  description  String?
  imageUrl     String?   @map("image_url")
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  storeId      String?   @map("store_id")
  store        Store?    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  products     Product[]
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("categories")
}

model Product {
  id                      String                  @id @default(uuid())
  categoryId              String?                 @map("category_id")
  category                Category?               @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  storeId                 String?                 @map("store_id")
  store                   Store?                  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name                    String
  description             String?
  price                   Float
  imageUrl                String?                 @map("image_url")
  isAvailable             Boolean                 @default(true) @map("is_available")
  displayOrder            Int                     @default(0) @map("display_order")
  orderItems              OrderItem[]
  productOptionCategories ProductOptionCategory[]
  recipe                  Recipe?
  createdAt               DateTime                @default(now()) @map("created_at")
  updatedAt               DateTime                @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("products")
}

model ProductOptionCategory {
  id            String          @id @default(uuid())
  productId     String          @map("product_id")
  product       Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  name          String
  isRequired    Boolean         @default(false) @map("is_required")
  minSelections Int             @default(1) @map("min_selections")
  maxSelections Int             @default(1) @map("max_selections")
  displayOrder  Int             @default(0) @map("display_order")
  options       ProductOption[]
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@map("product_option_categories")
}

model ProductOption {
  id               String                @id @default(uuid())
  optionCategoryId String                @map("option_category_id")
  optionCategory   ProductOptionCategory @relation(fields: [optionCategoryId], references: [id], onDelete: Cascade)
  name             String
  priceModifier    Float                 @default(0) @map("price_modifier")
  isAvailable      Boolean               @default(true) @map("is_available")
  displayOrder     Int                   @default(0) @map("display_order")
  createdAt        DateTime              @default(now()) @map("created_at")
  updatedAt        DateTime              @updatedAt @map("updated_at")

  @@map("product_options")
}

// Extras globales (modelo/plantilla)
model Extra {
  id         String   @id @default(uuid())
  name       String
  basePrice  Float    @default(0) @map("base_price")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("extras")
}

// Insumos/Ingredientes para control de inventario
model Ingredient {
  id            String   @id @default(uuid())
  name          String
  unit          String   // 'kg', 'unidad', 'litro', 'g'
  purchasePrice Float    @map("purchase_price")
  currentStock  Float    @default(0) @map("current_stock")
  minStock      Float    @default(0) @map("min_stock")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("ingredients")
}

model Recipe {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  ingredients Json     // Array de {ingredient_id, ingredient_name, quantity}
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([productId])
  @@map("recipes")
}

model Order {
  id                  String                     @id @default(uuid())
  orderNumber         String                     @unique @map("order_number")
  customerName        String                     @map("customer_name")
  customerPhone       String?                    @map("customer_phone")
  customerAddress     String?                    @map("customer_address")
  customerLat         Float?                     @map("customer_lat") // Latitud de la direcci칩n del cliente
  customerLng         Float?                     @map("customer_lng") // Longitud de la direcci칩n del cliente
  userId              String?                    @map("user_id") // Usuario autenticado (login social)
  user                User?                      @relation(fields: [userId], references: [id], onDelete: SetNull)
  storeId            String?                   @map("store_id")
  store              Store?                     @relation(fields: [storeId], references: [id], onDelete: SetNull)
  status              String                     @default("pending") // pending, confirmed, preparing, ready, assigned, in_transit, delivered, cancelled
  paymentMethod       String?                    @map("payment_method")
  paymentStatus       String                     @default("pending") @map("payment_status")
  subtotal            Float
  deliveryFee         Float                      @default(0) @map("delivery_fee")
  total               Float
  notes               String?
  deliveryCode        String?                    @map("delivery_code") // C칩digo de entrega
  trackingToken       String?                    @unique @map("tracking_token") // Token 칰nico para tracking p칰blico
  uniqueCode          String?                    @unique @map("unique_code") // C칩digo 칰nico de 4 d칤gitos para el mensaje de confirmaci칩n
  deliveryPersonId    String?                    @unique @map("delivery_person_id")
  deliveryPerson      DeliveryPerson?            @relation(fields: [deliveryPersonId], references: [id], onDelete: SetNull)
  items               OrderItem[]
  whatsappMessages    WhatsAppMessage[]
  pendingTransfers    PendingTransfer[]
  balanceTransactions DriverBalanceTransaction[]
  createdAt           DateTime                   @default(now()) @map("created_at")
  updatedAt           DateTime                   @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("orders")
}

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String   @map("order_id")
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String?  @map("product_id")
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productName     String   @map("product_name")
  quantity        Int      @default(1)
  unitPrice        Float    @map("unit_price")
  subtotal        Float
  selectedOptions String?  @map("selected_options")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("order_items")
}

model BotMessage {
  id          String   @id @default(uuid())
  storeId     String?  @map("store_id")
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  messageKey  String   @unique @map("message_key")
  messageText String   @map("message_text")
  messageType String   @default("text") @map("message_type")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("bot_messages")
}

model WhatsAppMessage {
  id          String   @id @default(uuid())
  orderId     String?  @map("order_id")
  order       Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  phoneNumber String   @map("phone_number")
  messageText String   @map("message_text")
  messageType String   @default("sent") @map("message_type")
  direction   String
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("whatsapp_messages")
}

model PendingTransfer {
  id                String    @id @default(uuid())
  orderId           String    @map("order_id")
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  storeId           String?   @map("store_id")
  store             Store?    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  transferReference String?   @map("transfer_reference")
  amount            Float
  status            String    @default("pending")
  proofImageUrl     String?   @map("proof_image_url")
  verifiedAt        DateTime? @map("verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("pending_transfers")
}

model DeliveryPerson {
  id                  String                     @id @default(uuid())
  name                String
  phone               String                     @unique
  username            String?                    @unique // Usuario para login
  password            String? // DEPRECATED: Mantener para migraci칩n, usar passwordHash
  passwordHash        String?                    @map("password_hash") // Hash bcrypt de la contrase침a
  isActive            Boolean                    @default(true) @map("is_active")
  currentOrderId      String?                    @unique @map("current_order_id")
  totalDeliveries     Int                        @default(0) @map("total_deliveries")
  lastLat             Float?                     @map("last_lat")
  lastLng             Float?                     @map("last_lng")
  lastSeenAt          DateTime?                  @map("last_seen_at")
  balance             Float                      @default(0)
  orders              Order[] // Relaci칩n con pedidos asignados
  balanceTransactions DriverBalanceTransaction[]
  sessions            DriverSession[] // Sesiones activas del repartidor
  createdAt           DateTime                   @default(now()) @map("created_at")
  updatedAt           DateTime                   @updatedAt @map("updated_at")

  @@map("delivery_persons")
}

// Sesiones de repartidores para control de tokens
model DriverSession {
  id        String   @id @default(uuid())
  driverId  String   @map("driver_id")
  driver    DeliveryPerson @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tokenHash String   @map("token_hash") // Hash SHA256 del token JWT
  deviceInfo String? @map("device_info")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([driverId])
  @@index([tokenHash])
  @@map("driver_sessions")
}

// Admins del sistema
model Admin {
  id          String   @id @default(uuid())
  username    String   @unique // Usuario (sin email)
  passwordHash String  @map("password_hash") // Hash bcrypt
  role        String   @default("admin") // admin, super_admin, operator, viewer
  storeId     String?  @map("store_id") // ID del store asignado (null para super_admin)
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: SetNull)
  isActive    Boolean  @default(true) @map("is_active")
  refreshTokens RefreshToken[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("admins")
}

// Refresh tokens para admins
model RefreshToken {
  id        String   @id @default(uuid())
  adminId   String   @map("admin_id")
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  tokenHash String   @map("token_hash") // Hash SHA256 del refresh token
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// Logs de auditor칤a
model AuditLog {
  id        String   @id @default(uuid())
  action    String   // Nombre de la acci칩n
  userId    String?  @map("user_id") // ID del usuario (admin o driver)
  userRole  String   @map("user_role") // Rol del usuario
  details   String?  // JSON con detalles adicionales
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

// Intentos de c칩digo de entrega (prevenir brute force)
model DeliveryCodeAttempt {
  id            String   @id @default(uuid())
  orderId       String   @map("order_id")
  driverId      String   @map("driver_id")
  attemptCount  Int      @default(0) @map("attempt_count")
  lastAttemptAt DateTime @map("last_attempt_at")

  @@unique([orderId, driverId])
  @@map("delivery_code_attempts")
}

model Customer {
  id                     String   @id @default(uuid())
  phone                  String   @unique
  name                   String?
  isBlocked              Boolean  @default(false) @map("is_blocked") // Si est치 bloqueado, no responde mensajes
  disabledPaymentMethods String?  @map("disabled_payment_methods") // JSON array: ["efectivo", "transferencia"]
  iuc                    String?  @unique // Identificador 칔nico de Cliente (4 d칤gitos)
  intentosInvalidos      Int      @default(0) @map("intentos_invalidos") // Contador de intentos inv치lidos
  ultimoIntento          DateTime? @map("ultimo_intento") // Timestamp del 칰ltimo intento inv치lido
  baneadoHasta           DateTime? @map("baneado_hasta") // Fecha hasta cuando est치 baneado
  cashPaymentStrikes     Int      @default(0) @map("cash_payment_strikes") // Strikes por cancelaciones de entrega en efectivo
  notes                  String?
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("customers")
  @@index([iuc])
}

model DriverBalanceTransaction {
  id        String         @id @default(uuid())
  driverId  String         @map("driver_id")
  driver    DeliveryPerson @relation(fields: [driverId], references: [id], onDelete: Cascade)
  orderId   String?        @map("order_id")
  order     Order?         @relation(fields: [orderId], references: [id], onDelete: SetNull)
  type      String // "delivery", "pago_admin", "ajuste"
  amount    Float // Positivo para sumar, negativo para restar
  reference String? // Referencia adicional (comentario, n칰mero de transferencia, etc.)
  createdAt DateTime       @default(now()) @map("created_at")

  @@map("driver_balance_transactions")
}

// Configuraci칩n del sistema
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   // JSON string con el valor de la configuraci칩n
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

// Estados del sistema (Modo Emergencia, Sin Stock)
model SystemState {
  id              String   @id @default(uuid())
  storeId         String?  @map("store_id")
  store           Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  emergencyMode   Boolean  @default(false) @map("emergency_mode") // Modo Emergencia activo
  noStockMode     Boolean  @default(false) @map("no_stock_mode") // Sin Stock activo
  activatedAt     DateTime? @map("activated_at")
  deactivatedAt   DateTime? @map("deactivated_at")
  activatedBy     String?  @map("activated_by") // ID del admin que activ칩
  notes           String?  // Notas sobre por qu칠 se activ칩
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("system_states")
}

// Checklist diario de tareas internas
model DailyChecklistTask {
  id          String   @id @default(uuid())
  storeId     String?  @map("store_id")
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  taskDate    DateTime @map("task_date") // Fecha del d칤a (solo fecha, sin hora)
  title       String   // T칤tulo de la tarea
  description String?  // Descripci칩n opcional
  emoji       String?  // Emoji para la tarea (ej: 游볪, 游빖, 游닍)
  isCompleted Boolean  @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  assignedTo  String?  @map("assigned_to") // Responsable (nombre o ID)
  priority    Int      @default(0) // 0 = normal, 1 = alta, 2 = urgente
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@index([taskDate])
  @@map("daily_checklist_tasks")
}

// Notificaciones del sistema
model SystemNotification {
  id          String   @id @default(uuid())
  storeId     String?  @map("store_id")
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  type        String   // 'stock_low', 'expiring', 'no_sales', 'price_suggestion', 'combo_recommendation', 'promotion_time', 'system_alert'
  title       String   // T칤tulo de la notificaci칩n
  message     String   // Mensaje de la notificaci칩n
  severity    String   @default("info") // 'info', 'warning', 'error', 'success'
  isRead      Boolean  @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  metadata    String?  // JSON con datos adicionales (productId, etc.)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([storeId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("system_notifications")
}

// Recomendaciones de IA del men칰
model AIRecommendation {
  id              String   @id @default(uuid())
  storeId         String?  @map("store_id")
  store           Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  type            String   // 'no_sales_product', 'suggested_combo', 'price_down', 'price_up', 'promotion_time'
  productId       String?  @map("product_id") // Si aplica a un producto espec칤fico
  productName     String?  @map("product_name")
  recommendation  String   // Descripci칩n de la recomendaci칩n
  data            String   // JSON con datos detallados (ventas, precios, etc.)
  dayGenerated    DateTime @map("day_generated") // D칤a en que se gener칩 (solo fecha)
  isAcknowledged  Boolean  @default(false) @map("is_acknowledged")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@index([dayGenerated])
  @@index([type])
  @@index([isAcknowledged])
  @@map("ai_recommendations")
}

// Historial de cierres autom치ticos del d칤a
model DailyClosure {
  id              String   @id @default(uuid())
  storeId         String?  @map("store_id")
  store           Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  closureDate     DateTime @unique @map("closure_date") // Fecha del cierre (00:00 del d칤a)
  totalSales      Float    @default(0) @map("total_sales")
  totalOrders     Int      @default(0) @map("total_orders")
  averageTicket   Float    @default(0) @map("average_ticket")
  summary         String?  // JSON con resumen completo del d칤a
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([storeId])
  @@index([closureDate])
  @@map("daily_closures")
}

// Modo Lluvia / Pico de Demanda
model PeakDemandMode {
  id                    String   @id @default(uuid())
  storeId               String?  @map("store_id")
  store                 Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  isActive              Boolean  @default(false) @map("is_active")
  estimatedTimeMinutes  Int      @default(20) @map("estimated_time_minutes") // Tiempo estimado adicional
  maxOrdersPerHour      Int?     @map("max_orders_per_hour") // L칤mite de pedidos por hora
  priceMultiplier       Float    @default(1.0) @map("price_multiplier") // Multiplicador de precios (1.0 = sin cambio)
  disabledProductIds    String?  @map("disabled_product_ids") // JSON array de IDs de productos deshabilitados
  activatedAt           DateTime? @map("activated_at")
  deactivatedAt         DateTime? @map("deactivated_at")
  notes                 String?  // Notas sobre por qu칠 se activ칩
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("peak_demand_modes")
}

// Clientes VIP / Fidelidad (basado en @lid de WhatsApp)
model CustomerLoyalty {
  id                  String   @id @default(uuid())
  customerId          String   @unique @map("customer_id") // ID @lid de WhatsApp (ej: "180375909310641@lid")
  tier                String   @default("bronze") // 'bronze', 'silver', 'gold', 'vip'
  totalPoints         Int      @default(0) @map("total_points") // Puntos totales acumulados
  totalOrders         Int      @default(0) @map("total_orders")
  totalSpent          Float    @default(0) @map("total_spent")
  lastOrderDate       DateTime? @map("last_order_date")
  favoriteProducts    String?  @map("favorite_products") // JSON array de IDs de productos favoritos
  discountPercentage  Float    @default(0) @map("discount_percentage") // Descuento autom치tico (%)
  priority            Boolean  @default(false) // Prioridad en cocina
  referredBy          String?  @map("referred_by") // ID @lid del invitador
  totalReferrals      Int      @default(0) @map("total_referrals") // Cantidad de referidos v치lidos
  birthday            String?  // Fecha de cumplea침os (MM-DD) para regalo anual
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  pointsHistory       PointsHistory[]
  referralsMade       Referral[] @relation("ReferrerReferrals")
  codeRedemptions     PromoCodeRedemption[]

  @@index([customerId])
  @@index([tier])
  @@index([totalPoints])
  @@map("customer_loyalty")
}

// Historial de puntos
model PointsHistory {
  id              String   @id @default(uuid())
  customerId      String   @map("customer_id") // ID @lid
  customerLoyalty CustomerLoyalty? @relation(fields: [customerId], references: [customerId])
  points          Int      // Puntos ganados/perdidos (positivo = ganado, negativo = canjeado)
  reason          String   // 'compra', 'referido', 'referidor', 'codigo_promocional', 'cumplea침os', 'mision_diaria', 'mision_semanal', 'primer_pedido', 'cliente_nuevo', 'manual_admin'
  description     String?  // Descripci칩n detallada
  orderId         String?  @map("order_id") // Si est치 relacionado con un pedido
  referralId      String?  @map("referral_id") // Si est치 relacionado con un referido
  referral        Referral? @relation(fields: [referralId], references: [id])
  promoCodeId     String?  @map("promo_code_id") // Si est치 relacionado con un c칩digo
  metadata        String?  // JSON con datos adicionales
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([customerId])
  @@index([createdAt])
  @@map("points_history")
}

// Sistema de referidos
model Referral {
  id                String   @id @default(uuid())
  referrerId        String   @map("referrer_id") // ID @lid del invitador
  referrerLoyalty   CustomerLoyalty? @relation("ReferrerReferrals", fields: [referrerId], references: [customerId])
  referredId        String   @unique @map("referred_id") // ID @lid del invitado
  status            String   @default("pending") // 'pending', 'validated', 'cancelled'
  validatedAt       DateTime? @map("validated_at")
  validationOrderId String?  @unique @map("validation_order_id") // Pedido que valid칩 el referido
  pointsAwarded     Int      @default(0) @map("points_awarded") // Puntos otorgados al invitador
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  pointsHistory     PointsHistory[]

  @@index([referrerId])
  @@index([referredId])
  @@index([status])
  @@map("referrals")
}

// C칩digos promocionales
model PromoCode {
  id                  String   @id @default(uuid())
  code                String   @unique // C칩digo 칰nico (ej: "NAVIDAD2025")
  type                String   // 'discount_percent', 'discount_fixed', 'free_product', 'bonus_points', 'level_upgrade', 'special_gift'
  value               Float    // Valor del beneficio (%, monto fijo, puntos, etc.)
  description         String?  // Descripci칩n del c칩digo
  productId           String?  @map("product_id") // Si type = 'free_product'
  levelRestriction    String?  @map("level_restriction") // JSON array: ["silver", "gold", "vip"] o null para todos
  maxTotalUses        Int?     @map("max_total_uses") // L칤mite total de usos
  maxUsesPerCustomer  Int      @default(1) @map("max_uses_per_customer") // L칤mite por cliente
  totalUses           Int      @default(0) @map("total_uses") // Usos actuales
  validFrom           DateTime @map("valid_from") // Fecha de inicio
  validUntil          DateTime @map("valid_until") // Fecha de expiraci칩n
  validHours          String?  @map("valid_hours") // JSON: { "from": "18:00", "to": "00:00" } o null para todo el d칤a
  isActive            Boolean  @default(true) @map("is_active")
  createdBy           String?  @map("created_by") // ID del admin que lo cre칩
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  redemptions         PromoCodeRedemption[]

  @@index([code])
  @@index([isActive])
  @@map("promo_codes")
}

// Canjes de c칩digos promocionales
model PromoCodeRedemption {
  id              String   @id @default(uuid())
  promoCodeId     String   @map("promo_code_id")
  promoCode       PromoCode @relation(fields: [promoCodeId], references: [id])
  customerId      String   @map("customer_id") // ID @lid
  customerLoyalty CustomerLoyalty? @relation(fields: [customerId], references: [customerId])
  orderId         String?  @map("order_id") // Si se aplic칩 a un pedido
  pointsAwarded   Int      @default(0) @map("points_awarded") // Si el c칩digo daba puntos
  redeemedAt      DateTime @default(now()) @map("redeemed_at")

  @@index([promoCodeId])
  @@index([customerId])
  @@unique([promoCodeId, customerId, orderId]) // Un c칩digo solo puede usarse una vez por cliente por pedido
  @@map("promo_code_redemptions")
}

// Configuraci칩n del sistema de fidelidad
model LoyaltyConfig {
  id                      String   @id @default(uuid())
  key                     String   @unique
  value                   String   // JSON con el valor de configuraci칩n
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("loyalty_config")
}

// Etiquetas inteligentes de productos
model ProductLabel {
  id          String   @id @default(uuid())
  storeId     String?  @map("store_id")
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  productId   String   @unique @map("product_id")
  labels      String   // JSON array: ["m치s_vendido", "recomendado", "pocas_ventas", "nuevo", "muy_pedido_hoy"]
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([storeId])
  @@index([productId])
  @@map("product_labels")
}

// Gastos reales del negocio
model BusinessExpense {
  id          String   @id @default(uuid())
  storeId     String?  @map("store_id")
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  date        DateTime // Fecha del gasto
  category    String   // 'proveedores', 'combustible', 'mantenimiento', 'herramientas', 'imprevistos', 'otros'
  description String   // Descripci칩n del gasto
  amount      Float    // Monto del gasto
  supplierId  String?  @map("supplier_id") // Si es compra a proveedor
  notes       String?  // Notas adicionales
  receiptUrl  String?  @map("receipt_url") // URL de comprobante
  createdBy   String?  @map("created_by") // ID del admin que registr칩
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@index([date])
  @@index([category])
  @@map("business_expenses")
}

// An치lisis de costo real del d칤a
model DailyCostAnalysis {
  id                    String   @id @default(uuid())
  storeId               String?  @map("store_id")
  store                 Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  analysisDate          DateTime @unique @map("analysis_date") // Fecha del an치lisis
  totalSales            Float    @default(0) @map("total_sales")
  totalExpenses         Float    @default(0) @map("total_expenses")
  ingredientCost        Float    @default(0) @map("ingredient_cost") // Costo de insumos usados
  laborCost             Float    @default(0) @map("labor_cost") // Costo laboral del d칤a
  wasteCost             Float    @default(0) @map("waste_cost") // Costo de desperdicio/merma
  totalCost             Float    @default(0) @map("total_cost") // Costo total
  netProfit             Float    @default(0) @map("net_profit") // Ganancia neta
  profitability         Float    @default(0) // Rentabilidad (%)
  hoursWorked           Float    @default(0) @map("hours_worked") // Horas trabajadas por empleados
  ordersCount           Int      @default(0) @map("orders_count")
  averageTicket         Float    @default(0) @map("average_ticket")
  details               String?  // JSON con detalles completos
  createdAt             DateTime @default(now()) @map("created_at")

  @@index([storeId])
  @@index([analysisDate])
  @@map("daily_cost_analyses")
}

// Referencias pendientes (cuando alguien entra por link de invitaci칩n)
model PendingReferral {
  id          String   @id @default(uuid())
  referredId  String   @unique @map("referred_id") // ID @lid del invitado
  referrerId  String   @map("referrer_id") // ID @lid del invitador
  visitedAt   DateTime @default(now()) @map("visited_at") // Cuando visit칩 el link
  expiresAt   DateTime @map("expires_at") // Expira despu칠s de 30 d칤as

  @@index([referredId])
  @@index([referrerId])
  @@map("pending_referrals")
}

// Horarios especiales (temporales, solo 1 d칤a)
model SpecialHours {
  id          String   @id @default(uuid())
  storeId     String?  @map("store_id")
  store       Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  isActive    Boolean  @default(true) @map("is_active")
  startTime   String   @map("start_time") // Formato HH:mm (ej: "14:00")
  endTime     String   @map("end_time") // Formato HH:mm (ej: "22:00")
  expiresAt   DateTime @map("expires_at") // Se resetea autom치ticamente despu칠s de 1 d칤a
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([storeId])
  @@map("special_hours")
}

// Stores (Locales/Tiendas)
model StoreCategory {
  id          String   @id @default(uuid())
  name        String   @unique // "Restaurantes", "Bebidas", "Kioscos", etc.
  slug        String   @unique // "restaurantes", "bebidas", "kioscos"
  icon        String?  // Emoji o icono
  color       String?  // Color de acento (hex)
  displayOrder Int     @default(0) @map("display_order")
  isActive    Boolean  @default(true) @map("is_active")
  stores      Store[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("store_categories")
}

model Store {
  id          String   @id @default(uuid())
  name        String
  categoryId  String?  @map("category_id") // Relaci칩n con StoreCategory
  category    StoreCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  imageUrl    String?  @map("image_url")
  description String?
  hours       String?  // Horarios de atenci칩n
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relaciones
  categories      Category[]
  products        Product[]
  orders          Order[]
  pendingTransfers PendingTransfer[]
  admins          Admin[]
  botMessages     BotMessage[]
  systemStates    SystemState[]
  dailyChecklistTasks DailyChecklistTask[]
  systemNotifications SystemNotification[]
  aiRecommendations AIRecommendation[]
  dailyClosures   DailyClosure[]
  peakDemandModes PeakDemandMode[]
  productLabels   ProductLabel[]
  businessExpenses BusinessExpense[]
  dailyCostAnalyses DailyCostAnalysis[]
  specialHours    SpecialHours[]
  settings        StoreSettings?

  @@index([categoryId])
  @@map("stores")
}

// Usuarios (clientes con login social)
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  phone         String?
  address       String?  // Direcci칩n guardada
  provider      String?  // 'google', 'apple'
  providerId    String?  @map("provider_id") // ID del proveedor (Google/Apple)
  imageUrl      String?  @map("image_url")
  orders        Order[]
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([provider, providerId])
  @@map("users")
}

// Configuraci칩n de tienda
model StoreSettings {
  id                String   @id @default(uuid())
  storeId           String   @unique
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  // Datos generales
  address           String?  // Direcci칩n del local
  
  // Horarios (JSON: { monday: {open: "10:00", close: "22:00"}, ... })
  hours             String?  @db.Text
  
  // M칠todos de entrega
  deliveryEnabled   Boolean  @default(true) @map("delivery_enabled")
  pickupEnabled     Boolean  @default(true) @map("pickup_enabled")
  
  // M칠todos de pago
  cashEnabled       Boolean  @default(true) @map("cash_enabled")
  transferEnabled   Boolean  @default(true) @map("transfer_enabled")
  transferAlias     String?  @map("transfer_alias")
  transferCvu       String?  @map("transfer_cvu")
  transferTitular   String?  @map("transfer_titular")
  mercadoPagoEnabled Boolean @default(false) @map("mercado_pago_enabled")
  mercadoPagoToken  String?  @map("mercado_pago_token")
  mercadoPagoKey    String?  @map("mercado_pago_key")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("store_settings")
}
